<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAN-13 條碼盤點掃描器</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: #f0f2f5;
            text-align: center;
        }
        h2 { color: #333; }
        #controls { margin-bottom: 15px; }
        button {
            padding: 12px 20px;
            margin: 5px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            transition: background-color 0.2s;
        }
        #btn-start { background-color: #28a745; } /* 綠色 */
        #btn-pause { background-color: #ffc107; color: black; display: none; } /* 黃色 */
        #btn-complete { background-color: #dc3545; display: none; } /* 紅色 */
        
        button:active { opacity: 0.8; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        #reader-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 20px auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background: #000;
        }
        /* 設定鏡頭區域高度，避免畫面跳動 */
        #reader {
            width: 100%;
            min-height: 300px; 
        }

        #result-section {
            display: none; /* 初始隱藏 */
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: auto;
        }

        #scan-list {
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            margin-bottom: 15px;
            border: 1px solid #eee;
            padding: 10px;
        }
        .scan-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #f0f0f0;
            padding: 5px 0;
        }
        .scan-item:last-child { border-bottom: none; }
        .item-code { font-family: monospace; font-weight: bold; }
        .item-qty { color: #28a745; font-weight: bold; }

        #download-controls {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #ccc;
        }
        input[type="text"] {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 70%;
            margin-bottom: 10px;
        }
        #btn-download {
            background-color: #007bff; /* 藍色 */
            width: 100%;
        }

        /* 狀態提示 */
        #status-msg {
            margin-bottom: 10px;
            font-weight: bold;
            color: #666;
            min-height: 1.2em;
        }
    </style>
</head>
<body>

    <h2>EAN-13 條碼盤點</h2>

    <div id="status-msg">準備就緒，請點擊「開始掃描」</div>

    <div id="controls">
        <button id="btn-start">開始掃描</button>
        <button id="btn-pause">暫停</button>
        <button id="btn-complete">完成</button>
    </div>

    <div id="reader-container">
        <div id="reader"></div>
    </div>

    <div id="result-section">
        <h3>已掃描清單</h3>
        <div id="scan-list"></div>

        <div id="download-controls">
            <p>請輸入檔案名稱：</p>
            <input type="text" id="filename-input" value="盤點結果" placeholder="輸入檔名">
            <span>.xlsx</span>
            <br>
            <button id="btn-download">下載 Excel 報表</button>
        </div>
    </div>

    <audio id="beep-sound" src="beep.mp3" preload="auto"></audio>
    
    <script>
        // === 變數初始化 ===
        let html5QrcodeScanner;
        let isScanning = false;
        let isPaused = false;
        // 儲存掃描數據：Key是條碼，Value是數量
        let scannedData = new Map(); 
        
        // 防重複掃描設定
        let lastScannedCode = null;
        let lastScannedTime = 0;
        const DEBOUNCE_TIME_MS = 2000; // 2秒

        // DOM 元素
        const btnStart = document.getElementById('btn-start');
        const btnPause = document.getElementById('btn-pause');
        const btnComplete = document.getElementById('btn-complete');
        const btnDownload = document.getElementById('btn-download');
        const resultSection = document.getElementById('result-section');
        const scanList = document.getElementById('scan-list');
        const statusMsg = document.getElementById('status-msg');
        const beepSound = document.getElementById('beep-sound');

        // === 核心功能：處理掃描成功 ===
        function onScanSuccess(decodedText, decodedResult) {
            const currentTime = new Date().getTime();

            // **核心邏輯：防止 2 秒內重複誤掃**
            if (decodedText === lastScannedCode && (currentTime - lastScannedTime < DEBOUNCE_TIME_MS)) {
                // 如果條碼相同且時間小於2秒，忽略這次掃描
                console.log("已忽略重複掃描: " + decodedText);
                return;
            }

            // 更新最後掃描狀態
            lastScannedCode = decodedText;
            lastScannedTime = currentTime;

            // **核心邏輯：自動計數**
            // 檢查 Map 中是否已有此條碼，有則+1，無則設為1
            let currentQty = scannedData.get(decodedText) || 0;
            scannedData.set(decodedText, currentQty + 1);

            // **核心邏輯：音效回饋**
            // 嘗試播放音效 (需要用戶先與頁面互動過才能播放)
            beepSound.play().catch(e => console.log("音效播放失敗(可能是瀏覽器限制):", e));

            updateUIStatus(`掃描成功: ${decodedText}`, "green");
            renderScanList();
        }

        function onScanFailure(error) {
            // 掃描失敗很常見（例如沒對準時），通常不需要特別處理，避免刷屏 console
            // console.warn(`Code scan error = ${error}`);
        }

        // === 介面與流程控制 ===

        // 開始掃描按鈕
        btnStart.addEventListener('click', () => {
            // 播放一次聲音以解鎖移動端瀏覽器的音頻限制
            beepSound.play().then(() => beepSound.pause()).catch(()=>{});

            if (!html5QrcodeScanner) {
                // 初始化掃描器實例
                html5QrcodeScanner = new Html5Qrcode("reader");
            }

            if (isPaused) {
                // 如果是暫停狀態，則恢復
                html5QrcodeScanner.resume();
                isPaused = false;
                updateButtonsState("scanning");
                updateUIStatus("繼續掃描中...", "blue");
            } else {
                // 全新開始
                const config = { 
                    fps: 10, // 每秒幀數，越高越耗能但反應越快
                    qrbox: { width: 250, height: 150 }, // 掃描框大小，長方形適合條碼
                    // 重要：指定只掃描 EAN-13，提高效能和準確度
                    formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13 ] 
                };
                
                // 使用後置鏡頭 (environment)
                html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .then(() => {
                    isScanning = true;
                    updateButtonsState("scanning");
                    updateUIStatus("正在掃描...", "blue");
                    resultSection.style.display = "block"; // 顯示結果區
                })
                .catch((err) => {
                    updateUIStatus("無法啟動鏡頭: " + err, "red");
                });
            }
        });

        // 暫停按鈕
        btnPause.addEventListener('click', () => {
            if (html5QrcodeScanner && isScanning && !isPaused) {
                html5QrcodeScanner.pause();
                isPaused = true;
                updateButtonsState("paused");
                updateUIStatus("已暫停", "orange");
            }
        });

        // 完成按鈕
        btnComplete.addEventListener('click', () => {
            if (html5QrcodeScanner && isScanning) {
                html5QrcodeScanner.stop().then(() => {
                    isScanning = false;
                    isPaused = false;
                    updateButtonsState("completed");
                    updateUIStatus("掃描完成，請下載報表", "green");
                    // 隱藏鏡頭區域
                    document.getElementById('reader-container').style.display = 'none';
                }).catch((err) => {
                    console.log("停止失敗", err);
                });
            }
        });

        // **核心功能：Excel 匯出**
        btnDownload.addEventListener('click', () => {
            if (scannedData.size === 0) {
                alert("目前沒有任何掃描數據！");
                return;
            }

            let filename = document.getElementById('filename-input').value || "盤點結果";
            
            // 1. 準備數據：將 Map 轉換為二維陣列 (Array of Arrays)
            // 加入標題列
            const ws_data = [
                ["條碼 (EAN-13)", "數量"] 
            ];
            // 加入數據列
            scannedData.forEach((qty, barcode) => {
                ws_data.push([barcode, qty]);
            });

            // 2. 創建工作表 (Worksheet)
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // 3. 創建工作簿 (Workbook) 並加入工作表
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "掃描數據");

            // 4. 下載檔案
            XLSX.writeFile(wb, `${filename}.xlsx`);
        });


        // === 輔助函數 ===

        // 更新按鈕顯示狀態
        function updateButtonsState(state) {
            if (state === "scanning") {
                btnStart.style.display = "none";
                btnPause.style.display = "inline-block";
                btnComplete.style.display = "inline-block";
            } else if (state === "paused") {
                btnStart.innerText = "繼續掃描";
                btnStart.style.display = "inline-block";
                btnPause.style.display = "none";
                btnComplete.style.display = "inline-block";
            } else if (state === "completed") {
                btnStart.innerText = "重新開始新的盤點";
                btnStart.style.display = "inline-block";
                btnPause.style.display = "none";
                btnComplete.style.display = "none";
            }
        }

        // 更新狀態文字顏色
        function updateUIStatus(text, color) {
            statusMsg.innerText = text;
            statusMsg.style.color = color || "black";
        }

        // 渲染畫面上的清單
        function renderScanList() {
            scanList.innerHTML = "";
            if (scannedData.size === 0) {
                scanList.innerHTML = "<p>尚未掃描任何條碼</p>";
                return;
            }
            // 反向遍歷 Map 以便最新的顯示在上面 (需要先轉成 Array)
            Array.from(scannedData).reverse().forEach(([code, qty]) => {
                let div = document.createElement('div');
                div.className = 'scan-item';
                div.innerHTML = `<span class="item-code">${code}</span><span class="item-qty">x ${qty}</span>`;
                scanList.appendChild(div);
            });
        }

    </script>
</body>
</html>
