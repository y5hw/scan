<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAN-13 極速盤點 (含補光燈)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { padding: 20px; font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; }
        .container { max-width: 800px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* 掃描區域與補光燈按鈕定位 */
        #reader-container { position: relative; margin-bottom: 15px; }
        #reader { width: 100%; background: #000; border-radius: 8px; overflow: hidden; }
        
        /* 補光燈按鈕 (懸浮在掃描框右下角) */
        #btn-flash {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 10;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: none; /* 預設隱藏，偵測到硬體支援才顯示 */
            opacity: 0.8;
        }

        #status-bar { font-weight: bold; margin-bottom: 15px; text-align: center; padding: 10px; border-radius: 5px; background-color: #e9ecef;}
        .status-scanning { background-color: #d1e7dd !important; color: #0f5132; border: 1px solid #badbcc; }
        .status-paused { background-color: #fff3cd !important; color: #664d03; border: 1px solid #ffecb5; }
        .count-badge { font-size: 1.1em; min-width: 40px; display: inline-block; text-align: center;}
        .last-scanned { background-color: #d1e7dd !important; transition: background-color 0.5s; }
        .btn-control { height: 60px; font-size: 1.1em; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-action { width: 32px; height: 32px; padding: 0; line-height: 30px; border-radius: 50%; }
    </style>
</head>
<body>

<div class="container">
    <h3 class="text-center mb-3 fw-bold"><i class="bi bi-upc-scan"></i> EAN-13 極速盤點</h3>

    <div id="status-bar">⚪ 系統待機中</div>

    <div id="reader-container">
        <div id="reader"></div>
        <button id="btn-flash" class="btn btn-light border border-secondary shadow" onclick="toggleFlash()">
            <i class="bi bi-lightning-fill text-dark" id="icon-flash"></i>
        </button>
    </div>

    <div id="error-msg" class="alert alert-danger d-none"></div>

    <div class="row g-2 mb-4">
        <div class="col-4">
            <button id="btn-start" class="btn btn-success w-100 btn-control shadow-sm" onclick="startScanning()">
                <i class="bi bi-camera-fill"></i> 掃描
            </button>
        </div>
        <div class="col-4">
            <button id="btn-pause" class="btn btn-warning w-100 text-white btn-control shadow-sm" onclick="pauseScanning()" disabled>
                <i class="bi bi-pause-circle-fill"></i> 暫停
            </button>
        </div>
        <div class="col-4">
            <button id="btn-finish" class="btn btn-primary w-100 btn-control shadow-sm" onclick="finishAndExport()" disabled>
                <i class="bi bi-file-earmark-spreadsheet-fill"></i> 匯出
            </button>
        </div>
    </div>

    <hr>

    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="m-0">掃描清單 (共 <span id="total-items" class="text-primary fw-bold">0</span> 品項 / <span id="total-qty" class="text-danger fw-bold">0</span> 總數)</h5>
        <button class="btn btn-sm btn-outline-danger" onclick="clearData()"><i class="bi bi-trash3"></i> 清空</button>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>條碼 (Barcode)</th>
                    <th style="width: 160px;" class="text-center">數量</th>
                    <th style="width: 60px;" class="text-center">操作</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="3" class="text-center text-muted py-3">尚未掃描任何條碼</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    // --- 變數宣告 ---
    let html5QrCode;
    let scanData = {};
    let lastScannedCode = null;
    let lastScanTime = 0;
    let isScanning = false;
    
    // 補光燈相關變數
    let isFlashOn = false;
    let hasFlash = false;

    // --- 初始化 ---
    window.onload = function() {
        // 鎖定 EAN-13 加速辨識
        const formatsToSupport = [
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.UPC_A
        ];
        html5QrCode = new Html5Qrcode("reader", { formatsToSupport: formatsToSupport });
        renderTable();
    };

    // --- 掃描功能 ---
    function startScanning() {
        const errorMsgDiv = document.getElementById('error-msg');
        errorMsgDiv.classList.add('d-none');
        
        // 隱藏補光燈按鈕 (直到偵測成功)
        document.getElementById('btn-flash').style.display = 'none';

        const config = { 
            fps: 20, 
            qrbox: { width: 280, height: 100 }, 
            aspectRatio: 1.0,
            disableFlip: false 
        };
        
        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            onScanSuccess, 
            onScanFailure
        ).then(() => {
            isScanning = true;
            updateUIState("scanning");
            
            // [新增] 啟動成功後，檢查是否有補光燈功能
            checkFlashCapability();

        }).catch(err => {
            console.error(err);
            errorMsgDiv.innerText = "相機啟動失敗：請確保使用 HTTPS 連線或允許相機權限。";
            errorMsgDiv.classList.remove('d-none');
        });
    }

    // [新增] 檢查並啟用補光燈控制
    function checkFlashCapability() {
        try {
            // 取得目前正在運行的相機軌道 (Video Track) 權限
            const track = html5QrCode.getRunningTrackCameraCapabilities();
            
            // 檢查是否支援 torch (手電筒/補光燈)
            // 注意：部分 iOS 裝置對網頁版 torch 支援度較差
            if (track && track.torchFeature && track.torchFeature.isSupported()) {
                hasFlash = true;
                const btnFlash = document.getElementById('btn-flash');
                btnFlash.style.display = 'block'; // 顯示按鈕
                isFlashOn = false; // 預設關閉
                updateFlashIcon();
            } else {
                console.log("此裝置或瀏覽器不支援網頁控制補光燈");
            }
        } catch (e) {
            console.log("無法偵測補光燈功能", e);
        }
    }

    // [新增] 切換補光燈
    function toggleFlash() {
        if (!isScanning || !hasFlash) return;

        isFlashOn = !isFlashOn;
        
        html5QrCode.applyVideoConstraints({
            advanced: [{ torch: isFlashOn }]
        })
        .then(() => {
            updateFlashIcon();
        })
        .catch(err => {
            console.error("補光燈切換失敗", err);
            // 如果失敗，把狀態切換回來
            isFlashOn = !isFlashOn;
        });
    }

    function updateFlashIcon() {
        const icon = document.getElementById('icon-flash');
        const btn = document.getElementById('btn-flash');
        if (isFlashOn) {
            icon.className = "bi bi-lightning-fill text-warning"; // 開啟時變黃色
            btn.className = "btn btn-dark border border-warning shadow";
        } else {
            icon.className = "bi bi-lightning-fill text-dark"; // 關閉時黑色
            btn.className = "btn btn-light border border-secondary shadow";
        }
    }

    function pauseScanning() {
        if (isScanning) {
            html5QrCode.stop().then(() => {
                isScanning = false;
                isFlashOn = false; // 暫停時重置燈光
                document.getElementById('btn-flash').style.display = 'none'; // 隱藏按鈕
                updateUIState("paused");
                document.getElementById('reader').innerHTML = ""; 
            }).catch(err => console.log(err));
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        const currentTime = new Date().getTime();
        if (decodedText === lastScannedCode && (currentTime - lastScanTime < 1500)) return;

        playBeep();
        lastScannedCode = decodedText;
        lastScanTime = currentTime;

        if (scanData[decodedText]) {
            scanData[decodedText]++;
        } else {
            scanData[decodedText] = 1;
        }

        renderTable();
        
        const readerDiv = document.getElementById('reader');
        readerDiv.style.boxShadow = "inset 0 0 0 5px #28a745";
        setTimeout(() => { readerDiv.style.boxShadow = "none"; }, 200);
    }

    function onScanFailure(error) {}

    // --- 資料操作 ---
    function updateQty(code, delta) {
        if (scanData[code] !== undefined) {
            scanData[code] += delta;
            if (scanData[code] <= 0) {
                if(confirm(`確定要刪除條碼 ${code} 嗎？`)) delete scanData[code];
                else scanData[code] = 1;
            }
            renderTable();
        }
    }

    function deleteItem(code) {
        if(confirm(`確定要移除條碼 ${code} 的所有紀錄嗎？`)) {
            delete scanData[code];
            renderTable();
        }
    }

    // --- 匯出功能 ---
    function finishAndExport() {
        if (isScanning) pauseScanning();
        if (Object.keys(scanData).length === 0) { alert("無資料可匯出"); return; }

        let fileName = prompt("請輸入檔案名稱：", generateDefaultFileName());
        if (fileName) {
            if (!fileName.endsWith('.xlsx')) fileName += '.xlsx';
            exportToExcel(fileName);
        }
    }

    function exportToExcel(fileName) {
        const dataForExcel = [];
        for (const [code, qty] of Object.entries(scanData)) {
            dataForExcel.push({ "條碼 (Barcode)": code, "數量 (Qty)": qty });
        }
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(dataForExcel);
        ws['!cols'] = [ {wch:25}, {wch:10} ];
        XLSX.utils.book_append_sheet(wb, ws, "盤點結果");
        XLSX.writeFile(wb, fileName);
    }

    // --- UI 渲染 ---
    function renderTable() {
        const tbody = document.getElementById('table-body');
        const totalItemsSpan = document.getElementById('total-items');
        const totalQtySpan = document.getElementById('total-qty');
        tbody.innerHTML = "";
        const entries = Object.entries(scanData);
        totalItemsSpan.innerText = entries.length;
        const totalQty = entries.reduce((acc, [_, qty]) => acc + qty, 0);
        totalQtySpan.innerText = totalQty;

        if (entries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">尚未掃描任何條碼</td></tr>';
            return;
        }

        [...entries].reverse().forEach(([code, qty]) => {
            const isLastScanned = (code === lastScannedCode);
            const rowClass = isLastScanned ? "last-scanned" : "";
            const row = `
                <tr class="${rowClass}">
                    <td class="align-middle fw-bold font-monospace">${code}</td>
                    <td class="text-center align-middle">
                        <div class="d-flex justify-content-center align-items-center gap-2">
                            <button class="btn btn-outline-secondary btn-action" onclick="updateQty('${code}', -1)"><i class="bi bi-dash"></i></button>
                            <span class="badge bg-primary count-badge">${qty}</span>
                            <button class="btn btn-outline-secondary btn-action" onclick="updateQty('${code}', 1)"><i class="bi bi-plus"></i></button>
                        </div>
                    </td>
                    <td class="text-center align-middle">
                         <button class="btn btn-outline-danger btn-action" onclick="deleteItem('${code}')"><i class="bi bi-x-lg"></i></button>
                    </td>
                </tr>`;
            tbody.innerHTML += row;
        });
    }

    function updateUIState(state) {
        const btnStart = document.getElementById('btn-start');
        const btnPause = document.getElementById('btn-pause');
        const btnFinish = document.getElementById('btn-finish');
        const statusBar = document.getElementById('status-bar');

        if (state === "scanning") {
            btnStart.disabled = true;
            btnPause.disabled = false;
            btnFinish.disabled = false;
            statusBar.innerHTML = '<span class="spinner-grow spinner-grow-sm" role="status"></span> 掃描中';
            statusBar.className = "status-scanning";
        } else if (state === "paused") {
            btnStart.disabled = false;
            btnStart.innerHTML = '<i class="bi bi-camera-fill"></i> 繼續掃描';
            btnPause.disabled = true;
            btnFinish.disabled = false;
            statusBar.innerText = "⏸ 已暫停";
            statusBar.className = "status-paused";
        } else {
            statusBar.innerText = "⚪ 系統待機中";
            statusBar.className = "";
        }
    }

    function clearData() {
        if(Object.keys(scanData).length > 0 && confirm("確定要清空所有資料嗎？")) {
            scanData = {};
            lastScannedCode = null;
            renderTable();
        }
    }

    function playBeep() {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(1500, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.08);
        } catch(e) {}
    }

    function generateDefaultFileName() {
        const date = new Date();
        return `盤點表_${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}_${date.getHours()}${date.getMinutes()}.xlsx`;
    }

</script>
</body>
</html>
