<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¢ç¢¼ç›¤é»ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; font-family: "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; }
        .container { max-width: 800px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        /* æƒæå€åŸŸæ¨£å¼ */
        #reader { width: 100%; min-height: 300px; background: #000; margin-bottom: 15px; border-radius: 5px; position: relative;}
        
        /* ç‹€æ…‹åˆ— */
        #status-bar { font-weight: bold; margin-bottom: 10px; text-align: center; }
        .status-idle { color: #6c757d; }
        .status-scanning { color: #198754; animation: blink 1.5s infinite; }
        .status-paused { color: #ffc107; }

        @keyframes blink { 50% { opacity: 0.5; } }

        /* è¡¨æ ¼æ¨£å¼ */
        .count-badge { font-size: 1.1em; }
        .last-scanned { background-color: #e8f5e9 !important; transition: background-color 1s; }
    </style>
</head>
<body>

<div class="container">
    <h3 class="text-center mb-3">æ¢ç¢¼æƒæè¨ˆæ•¸å™¨</h3>

    <div id="status-bar" class="status-idle">ç›®å‰ç‹€æ…‹ï¼šå¾…æ©Ÿä¸­</div>

    <div id="reader"></div>

    <div id="error-msg" class="alert alert-danger d-none"></div>

    <div class="row g-2 mb-4">
        <div class="col-4">
            <button id="btn-start" class="btn btn-success w-100 py-3" onclick="startScanning()">
                <i class="bi bi-play-fill"></i> é–‹å§‹æƒæ
            </button>
        </div>
        <div class="col-4">
            <button id="btn-pause" class="btn btn-warning w-100 py-3 text-white" onclick="pauseScanning()" disabled>
                <i class="bi bi-pause-fill"></i> æš«åœ
            </button>
        </div>
        <div class="col-4">
            <button id="btn-finish" class="btn btn-primary w-100 py-3" onclick="finishAndExport()" disabled>
                <i class="bi bi-file-earmark-excel"></i> å®Œæˆä¸¦åŒ¯å‡º
            </button>
        </div>
    </div>

    <hr>

    <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>æƒææ¸…å–® (<span id="total-count">0</span> é …)</h4>
        <button class="btn btn-sm btn-outline-danger" onclick="clearData()">æ¸…ç©ºè¡¨æ ¼</button>
    </div>

    <table class="table table-bordered table-hover">
        <thead class="table-dark">
            <tr>
                <th>æ¢ç¢¼å…§å®¹ (Barcode)</th>
                <th style="width: 100px;">æ•¸é‡</th>
            </tr>
        </thead>
        <tbody id="table-body">
            <tr><td colspan="2" class="text-center text-muted">å°šæœªæƒæä»»ä½•æ¢ç¢¼</td></tr>
        </tbody>
    </table>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    // --- è®Šæ•¸å®£å‘Š ---
    let html5QrCode;
    let scanData = {}; // æ ¼å¼: { "barcode1": 5, "barcode2": 3 }
    let lastScannedCode = null;
    let lastScanTime = 0;
    let isScanning = false;
    
    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        // å»ºç«‹æƒæå™¨å¯¦ä¾‹ (ä½¿ç”¨ verbose=false æ¸›å°‘ log)
        html5QrCode = new Html5Qrcode("reader");
        renderTable();
    };

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šé–‹å§‹æƒæ ---
    function startScanning() {
        const errorMsgDiv = document.getElementById('error-msg');
        errorMsgDiv.classList.add('d-none'); // éš±è—éŒ¯èª¤è¨Šæ¯

        // è¨­å®šæƒæåƒæ•¸
        const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
        
        // å˜—è©¦å•Ÿå‹•ä¸»é¡é ­ (facingMode: "environment")
        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            onScanSuccess, 
            onScanFailure
        ).then(() => {
            isScanning = true;
            updateUIState("scanning");
            console.log("æƒæå™¨å·²å•Ÿå‹•");
        }).catch(err => {
            console.error("å•Ÿå‹•å¤±æ•—", err);
            errorMsgDiv.innerText = "ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹ç¢ºèªç€è¦½å™¨æ¬Šé™æˆ–ä½¿ç”¨ HTTPS é€£ç·šã€‚";
            errorMsgDiv.classList.remove('d-none');
        });
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæš«åœæƒæ ---
    function pauseScanning() {
        if (isScanning) {
            html5QrCode.stop().then(() => {
                isScanning = false;
                updateUIState("paused");
                console.log("æƒæå·²æš«åœ");
                document.getElementById('reader').innerHTML = ""; // æ¸…é™¤ç•«é¢
            }).catch(err => {
                console.log("æš«åœå¤±æ•—", err);
            });
        }
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæƒææˆåŠŸå›å‘¼ ---
    function onScanSuccess(decodedText, decodedResult) {
        const currentTime = new Date().getTime();

        // é˜²é‡è¤‡æ©Ÿåˆ¶ (2ç§’å…§æƒåˆ°åŒä¸€å€‹ä¸è¨ˆæ•¸)
        if (decodedText === lastScannedCode && (currentTime - lastScanTime < 2000)) {
            return;
        }

        // 1. æ’­æ”¾éŸ³æ•ˆ
        playBeep();

        // 2. æ›´æ–°é‚è¼¯
        lastScannedCode = decodedText;
        lastScanTime = currentTime;

        if (scanData[decodedText]) {
            scanData[decodedText]++;
        } else {
            scanData[decodedText] = 1;
        }

        // 3. æ›´æ–°ä»‹é¢
        renderTable();
        
        // 4. è¦–è¦ºå›é¥‹ (é–ƒçˆä¸€ä¸‹è¡¨ç¤ºæˆåŠŸ)
        const readerDiv = document.getElementById('reader');
        readerDiv.style.border = "5px solid #28a745";
        setTimeout(() => { readerDiv.style.border = "none"; }, 200);
    }

    // å¿½ç•¥æƒæéç¨‹ä¸­çš„éŒ¯èª¤ (å¦‚æ­£åœ¨å°ç„¦)
    function onScanFailure(error) {}

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šå®Œæˆä¸¦åŒ¯å‡º ---
    function finishAndExport() {
        // å…ˆæš«åœæƒæ
        if (isScanning) {
            pauseScanning();
        }

        if (Object.keys(scanData).length === 0) {
            alert("ç›®å‰æ²’æœ‰ä»»ä½•è³‡æ–™ï¼Œç„¡æ³•å»ºç«‹è¡¨æ ¼ã€‚");
            return;
        }

        // è®“ä½¿ç”¨è€…è¼¸å…¥æª”å
        let fileName = prompt("è«‹è¼¸å…¥æª”æ¡ˆåç¨±ï¼š", generateDefaultFileName());
        
        if (fileName) {
            // ç¢ºä¿æª”åæœ‰ .xlsx å¾Œç¶´
            if (!fileName.endsWith('.xlsx')) {
                fileName += '.xlsx';
            }
            exportToExcel(fileName);
        }
    }

    // --- è¼”åŠ©åŠŸèƒ½ï¼šç”¢ç”Ÿ Excel ---
    function exportToExcel(fileName) {
        const dataForExcel = [];
        // å°‡ç‰©ä»¶è½‰ç‚ºé™£åˆ—
        for (const [code, qty] of Object.entries(scanData)) {
            dataForExcel.push({ "æ¢ç¢¼å…§å®¹": code, "æ•¸é‡": qty });
        }

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(dataForExcel);
        
        // è¨­å®šæ¬„å¯¬ (ç¾è§€)
        const wscols = [ {wch:30}, {wch:10} ];
        ws['!cols'] = wscols;

        XLSX.utils.book_append_sheet(wb, ws, "ç›¤é»çµæœ");
        XLSX.writeFile(wb, fileName);
    }

    // --- è¼”åŠ©åŠŸèƒ½ï¼šæ›´æ–°è¡¨æ ¼ UI ---
    function renderTable() {
        const tbody = document.getElementById('table-body');
        const totalCountSpan = document.getElementById('total-count');
        tbody.innerHTML = "";

        const entries = Object.entries(scanData);
        totalCountSpan.innerText = entries.length;

        if (entries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">å°šæœªæƒæä»»ä½•æ¢ç¢¼</td></tr>';
            return;
        }

        // åè½‰é™£åˆ—ï¼Œè®“æœ€æ–°æƒæçš„é¡¯ç¤ºåœ¨æœ€ä¸Šé¢
        // æˆ‘å€‘å¯ä»¥æŠŠæœ€å¾Œæƒæçš„é‚£å€‹ç‰¹åˆ¥æ¨™è¨˜å‡ºä¾†
        const reversedEntries = [...entries].reverse(); 

        reversedEntries.forEach(([code, qty]) => {
            const isLastScanned = (code === lastScannedCode);
            const rowClass = isLastScanned ? "last-scanned" : "";
            
            const row = `<tr class="${rowClass}">
                            <td class="align-middle">${code}</td>
                            <td><span class="badge bg-primary count-badge">${qty}</span></td>
                         </tr>`;
            tbody.innerHTML += row;
        });
    }

    // --- è¼”åŠ©åŠŸèƒ½ï¼šç‹€æ…‹ç®¡ç† ---
    function updateUIState(state) {
        const btnStart = document.getElementById('btn-start');
        const btnPause = document.getElementById('btn-pause');
        const btnFinish = document.getElementById('btn-finish');
        const statusBar = document.getElementById('status-bar');

        if (state === "scanning") {
            btnStart.disabled = true;
            btnPause.disabled = false;
            btnFinish.disabled = false;
            statusBar.innerText = "ğŸŸ¢ æ­£åœ¨æƒæä¸­... (è«‹å°æº–æ¢ç¢¼)";
            statusBar.className = "status-scanning";
        } else if (state === "paused") {
            btnStart.disabled = false;
            btnStart.innerHTML = '<i class="bi bi-play-fill"></i> ç¹¼çºŒæƒæ';
            btnPause.disabled = true;
            btnFinish.disabled = false;
            statusBar.innerText = "ğŸŸ¡ å·²æš«åœ";
            statusBar.className = "status-paused";
        } else {
            // idle
            statusBar.innerText = "âšª å¾…æ©Ÿä¸­";
            statusBar.className = "status-idle";
        }
    }

    // --- è¼”åŠ©åŠŸèƒ½ï¼šæ¸…ç©ºè³‡æ–™ ---
    function clearData() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºç›®å‰æ‰€æœ‰åˆ—è¡¨è³‡æ–™å—ï¼Ÿ")) {
            scanData = {};
            lastScannedCode = null;
            renderTable();
        }
    }

    // --- è¼”åŠ©åŠŸèƒ½ï¼šéŸ³æ•ˆ ---
    function playBeep() {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(1200, audioCtx.currentTime); // è¼ƒé«˜é »æ¸…è„†è²éŸ³
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        } catch(e) {
            console.log("Audio play failed"); // éƒ¨åˆ†ç€è¦½å™¨é™åˆ¶è‡ªå‹•æ’­æ”¾
        }
    }

    // ç”¢ç”Ÿé è¨­æª”å
    function generateDefaultFileName() {
        const date = new Date();
        const mm =String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const hh = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        return `ç›¤é»è¡¨_${mm}${dd}_${hh}${min}.xlsx`;
    }

</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

</body>
</html>
