<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>極速條碼掃描器 (EAN專用)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .header {
            background: #fff;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }
        h2 { margin: 0; font-size: 1.2rem; color: #333; }
        .status { font-size: 0.9rem; color: #28a745; margin-top: 5px; }
        
        /* 掃描視窗容器 */
        #scanner-container {
            position: relative;
            flex: 1;
            background: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* 影片元素 */
        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 讓畫面填滿 */
        }

        /* 掃描框框 (視覺引導) */
        .scan-region {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 250px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); /*以此模擬遮罩*/
            z-index: 5;
        }
        .scan-region::after {
            content: "請將條碼置於此框內";
            position: absolute;
            bottom: -30px;
            left: 0;
            width: 100%;
            text-align: center;
            color: #fff;
            font-size: 0.9rem;
        }

        /* 掃描結果列表 */
        .result-panel {
            background: #fff;
            padding: 15px;
            height: 150px;
            overflow-y: auto;
            border-top: 1px solid #ddd;
        }
        .result-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        /* 綠色偵測框 (Quagga 自動繪製) */
        .drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 4;
        }
    </style>
</head>
<body>

    <div class="header">
        <h2>極速條碼掃描 (服飾標籤專用)</h2>
        <div class="status" id="status-text">相機準備中...</div>
    </div>

    <div id="scanner-container">
        <div class="scan-region"></div>
        </div>

    <div class="result-panel" id="result-list">
        <div style="color: #888; text-align: center; margin-top: 10px;">
            掃描結果將顯示於此
        </div>
    </div>

    <script>
        // 聲音提示
        const beepSound = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'); // 簡單的 Beep 聲佔位符，建議換成真實音效路徑

        let lastCode = "";
        let lastTime = 0;

        function startScanner() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'),
                    constraints: {
                        width: 640,   // 【優化1】降低解析度以提升FPS
                        height: 480,
                        facingMode: "environment" // 使用後鏡頭
                    }
                },
                locator: {
                    patchSize: "medium", // 【優化2】掃描框大小
                    halfSample: true     // 【優化3】關鍵！只處理一半像素，速度大增
                },
                numOfWorkers: 4,         // 【優化4】使用多核心運算
                decoder: {
                    // 【優化5】只開啟 EAN (一般商品) 和 Code 128 (物流)，關閉其他不用的解碼器
                    readers: ["ean_reader", "code_128_reader"] 
                },
                locate: true // 顯示綠色追蹤框
            }, function(err) {
                if (err) {
                    console.log(err);
                    document.getElementById('status-text').innerText = "相機啟動失敗：" + err;
                    document.getElementById('status-text').style.color = "red";
                    return;
                }
                console.log("Initialization finished. Ready to start");
                document.getElementById('status-text').innerText = "正在掃描中... (請對準條碼)";
                Quagga.start();
            });

            // 偵測處理 (畫出綠色框框)
            Quagga.onProcessed(function(result) {
                var drawingCtx = Quagga.canvas.ctx.overlay,
                    drawingCanvas = Quagga.canvas.dom.overlay;

                if (result) {
                    if (result.boxes) {
                        drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                        result.boxes.filter(function (box) {
                            return box !== result.box;
                        }).forEach(function (box) {
                            Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                        });
                    }

                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                    }

                    if (result.codeResult && result.codeResult.code) {
                        Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
                    }
                }
            });

            // 掃描成功回調
            Quagga.onDetected(function(result) {
                var code = result.codeResult.code;
                var now = new Date().getTime();

                // 防止短時間內重複掃描同一條碼 (1秒冷卻)
                if (code === lastCode && now - lastTime < 1000) {
                    return;
                }

                lastCode = code;
                lastTime = now;
                
                // 播放聲音 (如果有的話)
                // beepSound.play().catch(e => console.log(e));

                // 顯示結果
                addResult(code, result.codeResult.format);
                
                // 視覺回饋：閃爍一下
                document.querySelector('.scan-region').style.borderColor = "#00ff00";
                setTimeout(() => {
                    document.querySelector('.scan-region').style.borderColor = "rgba(255, 255, 255, 0.6)";
                }, 300);
            });
        }

        function addResult(code, format) {
            const list = document.getElementById('result-list');
            // 清除預設文字
            if(list.innerText.includes('掃描結果將顯示於此')) list.innerHTML = '';

            const item = document.createElement('div');
            item.className = 'result-item';
            
            const time = new Date().toLocaleTimeString();
            item.innerHTML = `
                <div>
                    <strong>${code}</strong> <br>
                    <small style="color:#666">${format}</small>
                </div>
                <div style="color:#888; font-size:0.8rem; align-self:center;">${time}</div>
            `;
            
            list.insertBefore(item, list.firstChild);
        }

        // 啟動
        startScanner();

    </script>
</body>
</html>
